<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Horas — Sushi Time</title>
  <link rel="icon" type="image/png" href="https://i.ibb.co/WNM23Yw9/openart-image-ZIIpk9-N6-1762450739264-raw.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- SheetJS para Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root { --primary:#6366f1; --secondary:#6b7280; --danger:#ef4444; --bg:#fafafa; --card:#ffffff; --radius:12px; --muted:#6b7280; --success:#10b981; }
    body{font-family:Inter, Arial, sans-serif;background:var(--bg);margin:0;padding:16px;color:#111827;transition:all .3s ease;}
    body.dark{background:#0f172a !important;}
    .container{max-width:1050px;margin:0 auto;background:var(--card);border-radius:var(--radius);box-shadow:0 8px 25px rgba(0,0,0,0.05);padding:16px;transition:background .3s ease;}
    body.dark .container{background:#1e293b;border-color:#334155;box-shadow:0 4px 20px rgba(0,0,0,0.3);}
    .brand{text-align:right;font-size:16px;font-weight:bold;color:var(--primary);margin-bottom:10px;}
   
    /* TOPBAR */
    .topbar{
      display:flex;
      justify-content:flex-start;
      align-items:center;
      gap:10px;
      margin-bottom:15px;
      flex-wrap:wrap;
      min-height:48px;
    }
    .topbar .spacer{flex:1}
    .card{border:1px solid #e5e7eb;border-radius:var(--radius);padding:16px;background:#fff;margin-top:14px;overflow-x:auto;transition:all .3s ease;}
    body.dark .card{background:#1e293b;border-color:#334155;color:#f9fafb;box-shadow:0 4px 20px rgba(0,0,0,0.3);}
    label{display:block;font-size:14px;color:var(--muted);margin-top:10px}
    input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb;margin-top:4px;font-size:14px;box-sizing:border-box}
    body.dark input, body.dark select{background:#334155;color:#e2e8f0;border-color:#475569;}
    body.dark input::placeholder{color:#94a3b8;}
    .form-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:6px}
    .form-row > div{flex:1;min-width:150px}
    .btn-group{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    /* BOTONES UNIFICADOS */
    button, .btn-label{
      padding:10px 16px;
      border-radius:8px;
      border:0;
      color:#fff;
      cursor:pointer;
      transition:background 0.3s, transform 0.1s;
      font-size:14px;
      font-weight:500;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      height:40px;
      min-width:160px;
      box-sizing:border-box;
    }
    button:active, .btn-label:active{transform:scale(0.97)}
    button.primary, .btn-label.primary{background:var(--primary)}
    button.secondary{background:var(--secondary)}
    button.ghost{background:transparent;color:var(--primary);border:1px solid #d1d5db}
    body.dark button.ghost{color:#cbd5e1;border-color:#475569;}
    body.dark button.ghost:hover{background:rgba(255,255,255,0.1);color:#fff;}
    .btn-label.primary:hover{background:#4f46e5;}
    table{width:100%;border-collapse:collapse;margin-top:14px;font-size:14px;min-width:600px}
    th,td{border-bottom:1px solid #e5e7eb;padding:10px;text-align:left}
    th{background:#f9fafb;color:var(--muted)}
    body.dark th{background:#1e293b;color:#cbd5e1;border-bottom:1px solid #334155;}
    body.dark td{border-bottom:1px solid #334155;color:#e2e8f0;}
    body.dark tbody tr:hover{background:rgba(99,102,241,0.2);}
    .badge{background:rgba(99,102,241,0.1);color:var(--primary);font-size:12px;padding:4px 8px;border-radius:999px;align-self:center}
    body.dark .badge{background:rgba(99,102,241,0.2);color:#a5b4fc;}
    .action-btn{padding:6px 10px;border-radius:6px;border:none;cursor:pointer;font-size:13px}
    .edit-btn{background:#c7d2fe;color:#1e3a8a}.del-btn{background:#fee2e2;color:#b91c1c}
    footer.status{position:relative;margin:20px auto 0 auto;display:inline-flex;gap:20px;align-items:center;justify-content:center;background:var(--card);padding:8px 14px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.05);font-size:14px;color:var(--muted);transition:all .3s ease;}
    body.dark footer.status{background:#1e293b;color:#94a3b8;border:1px solid #334155;}
    .status .online{color:#16a34a;font-weight:700;display:inline-flex;align-items:center;gap:8px}
    body.dark .status .online{color:#34d399;}
    .status .online::before{content:'';width:10px;height:10px;border-radius:50%;background:#16a34a;display:inline-block;animation:blink 1s linear infinite}
    body.dark .status .online::before{background:#34d399;box-shadow:0 0 8px rgba(52,211,153,0.6);}
    @keyframes blink{0%,50%{opacity:1;transform:scale(1)}51%,100%{opacity:0.25;transform:scale(0.9)}}
    
    /* CAMPEÓN DEL MES - EFECTOS ÉPICOS */
    .champion-employee {
      background: linear-gradient(135deg, #fbbf24, #f59e0b, #f97316) !important;
      animation: championGlow 3s ease-in-out infinite alternate;
      position: relative;
      overflow: hidden;
    }
    body.dark .champion-employee {
      filter: brightness(1.1) saturate(1.2);
    }
    .champion-employee td {
      color: white !important;
      text-shadow: 0 2px 8px rgba(0,0,0,0.5);
      font-weight: 800;
      font-size: 16px;
    }
    body.dark .champion-employee td {
      text-shadow: 0 2px 6px rgba(0,0,0,0.7) !important;
    }
    .champion-name {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      animation: floatName 4s ease-in-out infinite;
      position: relative;
      z-index: 2;
    }
    .champion-crown {
      color: #fbbf24;
      font-size: 20px;
      animation: crownPulse 2s infinite;
      filter: drop-shadow(0 0 8px #fbbf24);
    }
    body.dark .champion-crown {
      filter: drop-shadow(0 0 10px #fbbf24) !important;
    }
    .champion-sparkles {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
      z-index: 1;
    }
    .champion-sparkles span {
      position: absolute;
      width: 6px;
      height: 6px;
      background: #fff;
      border-radius: 50%;
      animation: sparkle 3s linear infinite;
      box-shadow: 0 0 10px #fff, 0 0 20px #fbbf24;
    }
    body.dark .champion-sparkles span {
      box-shadow: 0 0 12px #fbbf24, 0 0 24px #f59e0b !important;
    }
    .champion-sparkles span:nth-child(1) { top: 20%; left: 10%; animation-delay: 0s; }
    .champion-sparkles span:nth-child(2) { top: 50%; left: 80%; animation-delay: 0.5s; }
    .champion-sparkles span:nth-child(3) { top: 70%; left: 20%; animation-delay: 1s; }
    .champion-sparkles span:nth-child(4) { top: 30%; left: 60%; animation-delay: 1.5s; }
    .champion-sparkles span:nth-child(5) { top: 80%; left: 90%; animation-delay: 2s; }

    @keyframes championGlow {
      from { box-shadow: 0 0 20px rgba(251, 191, 36, 0.6); }
      to { box-shadow: 0 0 40px rgba(251, 191, 36, 0.9), 0 0 60px rgba(249, 115, 22, 0.5); }
    }
    @keyframes floatName {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-6px) rotate(2deg); }
    }
    @keyframes crownPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    @keyframes sparkle {
      0% { transform: translateY(0) translateX(0) scale(0); opacity: 0; }
      50% { opacity: 1; }
      100% { transform: translateY(-100px) translateX(100px) scale(1); opacity: 0; }
    }

    .second-employee td:first-child {
      color: #94a3b8 !important;
      font-weight: 700;
    }
    body.dark .second-employee td:first-child {
      color: #e2e8f0 !important;
    }
    .second-employee:hover {
      background: rgba(148, 163, 184, 0.15) !important;
    }
    body.dark .second-employee:hover {
      background: rgba(148, 163, 184, 0.25) !important;
    }

    #instagramFloatContainer {
      position: fixed; bottom: -148px; right: -55px; z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 8px;
    }
    #instagramFloat { background: transparent; border: none; cursor: pointer; padding: 0; transition: transform 0.2s ease; animation: pulse 2s infinite; }
    #instagramFloat:hover { transform: scale(1.15); }
    #instagramFloat img { width: 200px; height: auto; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.2)); }
    body.dark #instagramFloat img { filter: drop-shadow(0 2px 8px rgba(0,0,0,0.6)) brightness(1.15) !important; }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
    @media (max-width: 768px) { #instagramFloatContainer { display: none !important; } }
    #loginModal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 99999; opacity: 0; pointer-events: none; transition: opacity .3s ease; }
    #loginModal.show { opacity: 1; pointer-events: auto; }
    .login-card { background: var(--card); border-radius: var(--radius); padding: 28px; width: 100%; max-width: 380px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); text-align: center; animation: modalIn .4s ease forwards; }
    body.dark .login-card { background: #1e293b; }
    @keyframes modalIn { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .login-card h2 { margin: 0 0 20px; font-size: 22px; color: var(--primary); }
    body.dark .login-card h2 { color: #a5b4fc; }
    .login-card .input-group { position: relative; margin-bottom: 16px; }
    .login-card .input-group i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted); }
    body.dark .login-card .input-group i { color: #94a3b8; }
    .login-card input, .login-card select { padding-left: 38px !important; height: 46px; font-size: 15px; }
    .login-card .btn-group { justify-content: center; margin-top: 20px; }
    .login-card .error { color: var(--danger); font-size: 13px; margin-top: 8px; display: none; }
    .login-card .error.show { display: block; }
    .login-card .logout-info { margin-top: 18px; font-size: 13px; color: var(--muted); }
    .login-card .logout-info span { color: var(--primary); font-weight: 600; }
    .readonly-mode .btn-group button:not(#btnLogoutTop),
    .readonly-mode .action-btn,
    .readonly-mode #empleado,
    .readonly-mode #entrada,
    .readonly-mode #salida,
    .readonly-mode #btnLimpiarLocal { opacity: 0.5; pointer-events: none; }
    .readonly-mode .badge { background: rgba(156,163,175,0.1); color: var(--secondary); }
    #editModal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 99998; opacity: 0; pointer-events: none; transition: opacity .3s ease; }
    #editModal.show { opacity: 1; pointer-events: auto; }
    .edit-card { background: var(--card); border-radius: var(--radius); padding: 24px; width: 100%; max-width: 420px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); animation: modalIn .3s ease forwards; }
    body.dark .edit-card { background: #1e293b; }
    .edit-card h3 { margin: 0 0 18px; font-size: 18px; color: var(--primary); }
    body.dark .edit-card h3 { color: #a5b4fc; }
    .edit-card .form-row { margin-top: 10px; }
    .edit-card .btn-group { justify-content: flex-end; margin-top: 20px; }
    .edit-card .btn-cancel { background: var(--secondary); }
    #permissionsModal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99997; opacity: 0; pointer-events: none; transition: opacity .3s ease; }
    #permissionsModal.show { opacity: 1; pointer-events: auto; }
    .user-perm-header { background: var(--primary); color: white; padding: 10px 14px; border-radius: 8px; font-weight: 600; font-size: 15px; margin: 18px 0 8px; }
    body.dark .user-perm-header { color: #fff; }
    .perm-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #e5e7eb; }
    body.dark .perm-item { border-bottom-color: #334155; }
    .perm-item:last-child { border: 0; }
    .perm-label { font-size: 14px; font-weight: 500; }
    body.dark .perm-label { color: #cbd5e1; }
    .switch{position:relative;display:inline-block;width:48px;height:26px;}
    .switch input{opacity:0;width:0;height:0;}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.4s;border-radius:34px;}
    .slider:before{position:absolute;content:"";height:20px;width:20px;left:3px;bottom:3px;background:white;transition:.4s;border-radius:50%;}
    input:checked + .slider{background:var(--success);}
    input:checked + .slider:before{transform:translateX(22px);}
    #permissionsContent::-webkit-scrollbar { width: 6px; }
    #permissionsContent::-webkit-scrollbar-track { background: transparent; }
    #permissionsContent::-webkit-scrollbar-thumb { background: rgba(100,100,100,0.3); border-radius: 3px; }
    body.dark #permissionsContent::-webkit-scrollbar-track { background: #1e293b; }
    body.dark #permissionsContent::-webkit-scrollbar-thumb { background: #475569; }
    body.dark #permissionsContent::-webkit-scrollbar-thumb:hover { background: #64748b; }

    /* ESTILOS MODAL LOGS */
    #logsModal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99996; opacity: 0; pointer-events: none; transition: opacity .3s ease; }
    #logsModal.show { opacity: 1; pointer-events: auto; }
    #logsContent table { min-width: 700px; font-size: 13px; }
    #logsContent th { background: #f3f4f6; font-weight: 600; }
    body.dark #logsContent th { background: #1e293b; }
    #logsContent td { padding: 8px 10px; }
    #logsContent tbody tr:hover { background: rgba(99,102,241,0.05); }
    body.dark #logsContent tbody tr:hover { background: rgba(99,102,241,0.15); }

    /* TRANSICIONES GLOBALES */
    * { transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; }
  </style>
</head>
<body>
  <!-- Loader Screen (5s) -->
  <div id="loaderPage" style="position:fixed;inset:0;background:#000;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:999999;gap:18px;">
    <img src="https://i.ibb.co/WNM23Yw9/openart-image-ZIIpk9-N6-1762450739264-raw.png" alt="Sushi Time Logo" style="width:340px;animation:float 2s ease-in-out infinite;filter:drop-shadow(0 0 10px rgba(255,255,255,0.3));" />
    <p style="color:white;font-size:18px;font-weight:600;letter-spacing:.5px;">Cargando Sushi Time…</p>
    <div style="width:220px;height:7px;background:rgba(255,255,255,0.25);border-radius:5px;overflow:hidden;">
      <div id="loaderProgress" style="height:100%;width:0%;background:#ff4d4d;transition:width .15s linear;"></div>
    </div>
  </div>
  <style>
    @keyframes float{0%{transform:translateY(0);}50%{transform:translateY(-10px);}100%{transform:translateY(0);}}
  </style>

  <!-- MODAL DE LOGIN -->
  <div id="loginModal">
    <div class="login-card">
      <h2>Acceso</h2>
      <div class="input-group">
        <i class="fa-solid fa-store"></i>
        <select id="modalLocal">
          <option value="pocitos">Sushi Time Pocitos</option>
          <option value="carrasco">Sushi Time Carrasco</option>
          <option value="lagomar">Sushi Time Lagomar</option>
        </select>
      </div>
      <div class="input-group">
        <i class="fa-solid fa-key"></i>
        <input type="password" id="modalPassword" placeholder="Contraseña" required />
      </div>
      <p class="error" id="loginError">Contraseña incorrecta</p>
      <div class="btn-group">
        <button id="btnLoginConfirm" class="primary">Ingresar</button>
        <button id="btnLoginCancel" class="ghost">Cancelar</button>
      </div>
      <div class="logout-info" id="logoutInfo" style="display:none;">
        Sesión: <span id="activeUser"></span> (<span id="activeLocal"></span>) — <a href="#" id="btnLogout" style="color:var(--primary);text-decoration:underline;">Cerrar sesión</a>
      </div>
    </div>
  </div>

  <!-- MODAL DE EDICIÓN -->
  <div id="editModal">
    <div class="edit-card">
      <h3>Editar Registro</h3>
      <label>Empleado</label>
      <input type="text" id="editEmpleado" />
      <div class="form-row">
        <div>
          <label>Día</label>
          <select id="editDia">
            <option value="martes">Martes</option>
            <option value="miercoles">Miércoles</option>
            <option value="jueves">Jueves</option>
            <option value="viernes">Viernes</option>
            <option value="sabado">Sábado</option>
            <option value="domingo">Domingo</option>
          </select>
        </div>
        <div>
          <label>Entrada</label>
          <input type="time" id="editEntrada" />
        </div>
        <div>
          <label>Salida</label>
          <input type="time" id="editSalida" />
        </div>
      </div>
      <div class="btn-group">
        <button id="btnEditCancel" class="btn-cancel ghost">Cancelar</button>
        <button id="btnEditSave" class="primary">Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL DE PERMISOS -->
  <div id="permissionsModal">
    <div class="edit-card" style="max-width:500px;width:100%;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h3 style="margin:0;color:var(--primary);">Permisos por Usuario</h3>
        <button id="btnClosePermissions" class="ghost" style="padding:6px 10px;font-size:18px;">×</button>
      </div>
      <div id="permissionsContent" style="max-height:60vh;overflow-y:auto;padding-right:8px;"></div>
      <div class="btn-group" style="justify-content:flex-end;margin-top:20px;">
        <button id="btnSavePermissions" class="primary">Guardar Cambios</button>
      </div>
    </div>
  </div>

  <!-- MODAL DE LOGS -->
  <div id="logsModal">
    <div class="edit-card" style="max-width:900px;width:100%;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h3 style="margin:0;color:var(--primary);">Historial de Inicios de Sesión</h3>
        <button id="btnCloseLogs" class="ghost" style="padding:6px 10px;font-size:18px;">×</button>
      </div>
      <div style="margin-bottom:12px;">
        <button id="btnExportLogs" class="primary" style="font-size:13px;padding:8px 12px;">
          <i class="fa-solid fa-file-export"></i> Exportar a Excel
        </button>
      </div>
      <div id="logsContent" style="max-height:60vh;overflow-y:auto;">
        <table>
          <thead><tr><th>Fecha</th><th>Usuario</th><th>Local</th><th>IP</th><th>Navegador</th></tr></thead>
          <tbody id="logsTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="container" id="mainApp" style="display:none;">
    <div class="topbar">
      <button class="ghost" id="darkModeBtn" type="button"><i class="fa-solid fa-moon"></i></button>
      <button id="btnExportar" class="primary">
        <i class="fa-solid fa-file-export"></i> Exportar a Excel
      </button>
      <button id="btnBackupCompleto" class="primary" style="display:none;">
        <i class="fa-solid fa-download"></i> Backup Completo (Excel)
      </button>
      <button id="btnOpenPermissions" class="ghost" style="display:none;">
        <i class="fa-solid fa-shield-halved"></i> Permisos
      </button>
      <button id="btnOpenLogs" class="ghost" style="display:none;">
        <i class="fa-solid fa-clock-rotate-left"></i> Logs
      </button>
      <button id="btnLogoutTop" class="ghost" style="display:none;">
        <i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión
      </button>
      <div class="spacer"></div>
      <div class="brand">Development by Christian Sena</div>
    </div>

    <div class="card">
      <label for="local">Local</label>
      <select id="local">
        <option value="pocitos">Sushi Time Pocitos</option>
        <option value="carrasco">Sushi Time Carrasco</option>
        <option value="lagomar">Sushi Time Lagomar</option>
      </select>
      <label for="empleado">Empleado</label>
      <input type="text" id="empleado" placeholder="Nombre del empleado" />
      <div class="form-row">
        <div>
         <label for="dia">Día</label>
         <select id="dia">
           <option value="martes" selected>Martes</option>
           <option value="miercoles">Miércoles</option>
           <option value="jueves">Jueves</option>
           <option value="viernes">Viernes</option>
           <option value="sabado">Sábado</option>
           <option value="domingo">Domingo</option>
         </select>
        </div>
        <div>
          <label for="entrada">Entrada</label>
          <input type="time" id="entrada" value="20:00" />
        </div>
        <div>
          <label for="salida">Salida</label>
          <input type="time" id="salida" />
        </div>
      </div>
      <div class="btn-group">
        <button id="btnAgregar" class="primary">Agregar</button>
        <button id="btnLimpiarLocal" class="secondary">Limpiar local</button>
        <span class="badge" id="countBadge">0 registros</span>
      </div>
    </div>

    <h3 style="margin-top:18px">Registros — <span id="localLabel">Pocitos</span></h3>
    <div class="card">
      <table>
        <thead>
          <tr><th>Empleado</th><th>Día</th><th>Entrada</th><th>Salida</th><th>Horas</th><th>Acciones</th></tr>
        </thead>
        <tbody id="tabla-registro"></tbody>
        <tfoot><tr><td><strong>Total</strong></td><td colspan="3"></td><td id="totalHoras">0h 0m 0s</td><td></td></tr></tfoot>
      </table>
    </div>

    <h3 style="margin-top:18px">Dashboard — Horas por Empleado</h3>
    <div class="card">
      <table>
        <thead>
          <tr><th>Empleado</th><th>Local</th><th>Total Horas</th></tr>
        </thead>
        <tbody id="tabla-dashboard"></tbody>
      </table>
    </div>

    <footer class="status" role="status" aria-live="polite">
      <div><span>Current status Server :</span> <span class="online" id="serverStatus">Online</span></div>
      <div><span>Current status Firebase :</span> <span class="online" id="firebaseStatus">Online</span></div>
    </footer>
  </div>

  <div id="instagramFloatContainer">
    <a href="https://www.instagram.com/sushitime.uy/" target="_blank" id="instagramFloat" aria-label="Síguenos en Instagram">
      <img src="https://i.ibb.co/1JPMxWnS/6a67f3cb-982a-4011-afff-9de099600bca-1.png" alt="Síguenos en Instagram" />
    </a>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, get, remove, onValue, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDSxZILNH92QqkfnQeSpYZeboqylAo_6S0",
  authDomain: "sushitime-b84fc.firebaseapp.com",
  databaseURL: "https://sushitime-b84fc-default-rtdb.firebaseio.com",
  projectId: "sushitime-b84fc",
  storageBucket: "sushitime-b84fc.firebasestorage.app",
  messagingSenderId: "821112951317",
  appId: "1:821112951317:web:2faf38dcf27489a5aab41c",
  measurementId: "G-12GZDY9MXZ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// === ELEMENTOS ===
const loginModal = document.getElementById('loginModal');
const modalLocal = document.getElementById('modalLocal');
const modalPassword = document.getElementById('modalPassword');
const btnLoginConfirm = document.getElementById('btnLoginConfirm');
const btnLoginCancel = document.getElementById('btnLoginCancel');
const loginError = document.getElementById('loginError');
const logoutInfo = document.getElementById('logoutInfo');
const activeUser = document.getElementById('activeUser');
const activeLocal = document.getElementById('activeLocal');
const btnLogout = document.getElementById('btnLogout');
const btnLogoutTop = document.getElementById('btnLogoutTop');
const editModal = document.getElementById('editModal');
const editEmpleado = document.getElementById('editEmpleado');
const editDia = document.getElementById('editDia');
const editEntrada = document.getElementById('editEntrada');
const editSalida = document.getElementById('editSalida');
const btnEditSave = document.getElementById('btnEditSave');
const btnEditCancel = document.getElementById('btnEditCancel');
const permissionsModal = document.getElementById('permissionsModal');
const btnOpenPermissions = document.getElementById('btnOpenPermissions');
const btnClosePermissions = document.getElementById('btnClosePermissions');
const btnSavePermissions = document.getElementById('btnSavePermissions');
const permissionsContent = document.getElementById('permissionsContent');
const mainApp = document.getElementById('mainApp');
const localSelect = document.getElementById("local");
const empleado = document.getElementById("empleado");
const dia = document.getElementById("dia");
const entrada = document.getElementById("entrada");
const salida = document.getElementById("salida");
const tabla = document.getElementById("tabla-registro");
const countBadge = document.getElementById("countBadge");
const totalHorasEl = document.getElementById("totalHoras");
const localLabel = document.getElementById("localLabel");
const btnAgregar = document.getElementById('btnAgregar');
const btnLimpiarLocal = document.getElementById('btnLimpiarLocal');
const btnExportar = document.getElementById('btnExportar');
const btnBackupCompleto = document.getElementById('btnBackupCompleto');
const btnOpenLogs = document.getElementById('btnOpenLogs');
const btnCloseLogs = document.getElementById('btnCloseLogs');
const btnExportLogs = document.getElementById('btnExportLogs');
const logsTableBody = document.getElementById('logsTableBody');

let editingId = null;
let currentPermissions = {
  canAdd: true, canEdit: true, canDelete: true, canClear: true, canExportImport: true, canEditOtherLocations: false
};

const LOCAL_PASSWORDS = {
  pocitos: "pocitos123",
  carrasco: "carrasco123",
  lagomar: "lagomar123",
  master: "Santiago2025"
};

let isLoggedIn = false;
let currentLocal = null;
let currentRole = null;
let originalLocal = null;

// === OBTENER IP Y NAVEGADOR ===
async function getClientInfo() {
  try {
    const res = await fetch('https://api.ipify.org?format=json');
    const data = await res.json();
    return { ip: data.ip, userAgent: navigator.userAgent };
  } catch {
    return { ip: 'desconocida', userAgent: navigator.userAgent };
  }
}

// === REGISTRAR LOGIN ===
async function registrarLogin(local, role) {
  const { ip, userAgent } = await getClientInfo();
  const ahora = new Date();
  const fecha = ahora.toLocaleString('es-UY', { timeZone: 'America/Montevideo' });

  const log = {
    local,
    role,
    ip,
    userAgent,
    fecha,
    timestamp: ahora.getTime()
  };

  const logRef = push(ref(db, 'loginLogs'));
  await set(logRef, log);
}

// === MOSTRAR LOGS EN TIEMPO REAL ===
let logsUnsubscribe = null;

async function iniciarLogsEnTiempoReal() {
  if (logsUnsubscribe) logsUnsubscribe();

  logsTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);">Cargando logs...</td></tr>';

  try {
    logsUnsubscribe = onValue(ref(db, 'loginLogs'), (snapshot) => {
      const logs = [];
      snapshot.forEach(c => {
        const data = c.val();
        logs.push({ id: c.key, ...data });
      });

      logs.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

      if (logs.length === 0) {
        logsTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);">No hay inicios de sesión registrados</td></tr>';
        return;
      }

      logsTableBody.innerHTML = logs.map(l => `
        <tr>
          <td>${l.fecha || '—'}</td>
          <td><strong>${(l.role || 'local').toUpperCase()}</strong></td>
          <td>${l.local || '—'}</td>
          <td><code>${l.ip || '—'}</code></td>
          <td style="font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${l.userAgent || ''}">${l.userAgent || '—'}</td>
        </tr>
      `).join('');
    }, (error) => {
      console.error("Error cargando logs:", error);
      logsTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#ef4444;">Error al cargar logs</td></tr>';
    });
  } catch (err) {
    console.error("Error iniciando logs:", err);
    logsTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#ef4444;">Error inesperado</td></tr>';
  }
}

// === EXPORTAR LOGS ===
btnExportLogs.addEventListener('click', async () => {
  try {
    const snapshot = await get(ref(db, 'loginLogs'));
    const data = [];
    snapshot.forEach(c => {
      const d = c.val();
      data.push({
        Fecha: d.fecha || '—',
        Rol: (d.role || 'local').toUpperCase(),
        Local: d.local || '—',
        IP: d.ip || '—',
        Navegador: d.userAgent || '—'
      });
    });
    if (data.length === 0) return alert("No hay logs para exportar.");

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, "Logs de Sesión");
    const now = new Date().toISOString().slice(0,16).replace('T', '_').replace(':', '');
    XLSX.writeFile(wb, `SushiTime_LOGIN_LOGS_${now}.xlsx`);
    alert(`Exportados ${data.length} inicios de sesión`);
  } catch (err) {
    alert("Error al exportar logs");
    console.error(err);
  }
});

// === EVENTOS LOGS ===
btnOpenLogs.addEventListener('click', () => {
  document.getElementById('logsModal').classList.add('show');
  iniciarLogsEnTiempoReal();
});

btnCloseLogs.addEventListener('click', () => {
  document.getElementById('logsModal').classList.remove('show');
  if (logsUnsubscribe) {
    logsUnsubscribe();
    logsUnsubscribe = null;
  }
});

document.getElementById('logsModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('logsModal')) {
    document.getElementById('logsModal').classList.remove('show');
    if (logsUnsubscribe) {
      logsUnsubscribe();
      logsUnsubscribe = null;
    }
  }
});

// === FORZAR LOGIN ===
function forceLogin() {
  localStorage.removeItem('sushiAdminSession');
  showLogin();
}
forceLogin();

function showLogin() {
  loginModal.classList.add('show');
  modalPassword.focus();
}

function logout() {
  localStorage.removeItem('sushiAdminSession');
  location.reload();
}

async function enterAdminMode(local, role) {
  isLoggedIn = true; currentLocal = local; currentRole = role; originalLocal = local;
  loginModal.classList.remove('show'); mainApp.style.display = 'block'; mainApp.classList.remove('readonly-mode');
  localSelect.value = local; localSelect.disabled = false;
  render(local); renderDashboard();
  activeUser.textContent = role === 'master' ? 'MASTER' : 'Local';
  activeLocal.textContent = localSelect.options[localSelect.selectedIndex].text;
  logoutInfo.style.display = 'block'; btnLogoutTop.style.display = 'inline-flex';
  if (role === 'master') {
    btnOpenPermissions.style.display = 'inline-flex';
    btnBackupCompleto.style.display = 'inline-flex';
    btnOpenLogs.style.display = 'inline-flex';
  }
  if (role === 'local') loadLocalPermissions(local);
  applyPermissions();
  await registrarLogin(local, role);
}

btnLoginConfirm.addEventListener('click', async () => {
  const selected = modalLocal.value;
  const pass = modalPassword.value.trim();

  if (!pass) {
    loginError.textContent = "La contraseña es obligatoria";
    loginError.classList.add('show');
    modalPassword.focus();
    setTimeout(() => loginError.classList.remove('show'), 3000);
    return;
  }

  if (pass === LOCAL_PASSWORDS.master) {
    await enterAdminMode(selected, 'master');
  } else if (pass === LOCAL_PASSWORDS[selected]) {
    await enterAdminMode(selected, 'local');
  } else {
    loginError.textContent = "Contraseña incorrecta";
    loginError.classList.add('show');
    modalPassword.value = '';
    modalPassword.focus();
    setTimeout(() => loginError.classList.remove('show'), 3000);
  }
});

btnLogoutTop.addEventListener('click', (e) => { e.preventDefault(); if (confirm("¿Cerrar sesión?")) logout(); });
btnLogout.addEventListener('click', (e) => { e.preventDefault(); logout(); });
modalPassword.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); btnLoginConfirm.click(); } });
btnLoginCancel.addEventListener('click', () => {
  if (confirm("¿Cancelar acceso? Se cerrará la página.")) {
    alert("Acceso denegado. Debes ingresar con contraseña.");
    window.close();
  }
});

// === BACKUP COMPLETO ===
btnBackupCompleto.addEventListener('click', async () => {
  if (currentRole !== 'master') return alert("Solo el MASTER puede hacer backup completo.");
  const snapshot = await get(ref(db, "registros"));
  const data = [];
  const localNames = { pocitos: "Pocitos", carrasco: "Carrasco", lagomar: "Lagomar" };
  snapshot.forEach(c => {
    const d = c.val();
    data.push({
      Local: localNames[d.local] || d.local,
      Empleado: d.empleado,
      Día: d.dia.charAt(0).toUpperCase() + d.dia.slice(1),
      Entrada: d.entrada,
      Salida: d.salida,
      Horas: formatHMS(d.segundos)
    });
  });
  if (data.length === 0) return alert("No hay registros para respaldar.");
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "Backup Completo");
  const now = new Date().toISOString().slice(0,16).replace('T', '_').replace(':', '');
  XLSX.writeFile(wb, `SushiTime_BACKUP_TODOS_${now}.xlsx`);
  alert(`Backup completo descargado: ${data.length} registros.`);
});

// === EXPORTAR ===
btnExportar.addEventListener('click', async () => {
  if (!currentPermissions.canExportImport) return alert("No tienes permiso para exportar.");
  const sel = localSelect.value;
  const snapshot = await get(ref(db, "registros"));
  const data = [];
  snapshot.forEach(c => {
    const d = c.val();
    if (d.local === sel) {
      data.push({
        Empleado: d.empleado,
        Día: d.dia.charAt(0).toUpperCase() + d.dia.slice(1),
        Entrada: d.entrada,
        Salida: d.salida,
        Horas: formatHMS(d.segundos)
      });
    }
  });
  if (data.length === 0) return alert("No hay registros para exportar.");
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "Registros");
  const now = new Date().toISOString().slice(0,10);
  XLSX.writeFile(wb, `SushiTime_${sel}_${now}.xlsx`);
  alert(`Exportado ${data.length} registros`);
});

function applyPermissions() {
  if (currentRole !== 'local') return;
  const can = currentPermissions.canExportImport;
  btnExportar.disabled = !can;
  btnExportar.style.opacity = can ? '1' : '0.5';
  btnExportar.style.pointerEvents = can ? 'auto' : 'none';
  updateLocalSelect();
}

function calcularSegundos(e, s) {
  if (!e || !s) return 0;
  const t1 = new Date("1970-01-01T" + e + ":00");
  const t2 = new Date("1970-01-01T" + s + ":00");
  let diff = (t2 - t1) / 1000;
  if (diff < 0) diff += 86400;
  return Math.round(diff);
}

function formatHMS(seconds) {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = seconds % 60;
  return `${h}h ${m}m ${s}s`;
}

btnAgregar.addEventListener("click", () => {
  if (!currentPermissions.canAdd) return alert("No tienes permiso para agregar.");
  if (!empleado.value.trim()) return alert("Ingrese un nombre");
  const id = Date.now();
  const segs = calcularSegundos(entrada.value, salida.value);
  const registro = { local: localSelect.value, empleado: empleado.value.trim(), dia: dia.value, entrada: entrada.value, salida: salida.value, segundos: segs };
  set(ref(db, "registros/" + id), registro);
  empleado.value = ""; salida.value = "";
});

btnLimpiarLocal.addEventListener("click", () => {
  if (!currentPermissions.canClear) return alert("No tienes permiso para limpiar.");
  const sel = localSelect.value;
  if (!confirm(`¿Limpiar registros del local ${sel}?`)) return;
  get(ref(db, "registros")).then((snap) => {
    snap.forEach((c) => { if (c.val().local === sel) remove(ref(db, "registros/" + c.key)); });
  });
});

function render(sel) {
  localLabel.textContent = localSelect.options[localSelect.selectedIndex].text;
  get(ref(db, "registros")).then((snapshot) => {
    tabla.innerHTML = ""; let total = 0, count = 0;
    snapshot.forEach((c) => {
      const d = c.val();
      if (d.local !== sel) return;
      total += parseInt(d.segundos) || 0;
      const canEditThis = (currentRole === 'master') ||
                         (currentRole === 'local' && (d.local === originalLocal || currentPermissions.canEditOtherLocations));
      const actions = canEditThis
        ? `<button class='action-btn edit-btn' data-id='${c.key}' ${!currentPermissions.canEdit ? 'disabled' : ''}><i class="fa-solid fa-pen"></i></button>
           <button class='action-btn del-btn' data-id='${c.key}' ${!currentPermissions.canDelete ? 'disabled' : ''}><i class="fa-solid fa-trash"></i></button>`
        : '';
      tabla.innerHTML += `<tr>
        <td>${d.empleado}</td><td>${d.dia}</td><td>${d.entrada}</td><td>${d.salida}</td><td>${formatHMS(d.segundos)}</td>
        <td>${actions}</td>
      </tr>`;
      count++;
    });
    totalHorasEl.textContent = formatHMS(total);
    countBadge.textContent = `${count} registros`;
  });
}

localSelect.addEventListener("change", () => {
  currentLocal = localSelect.value;
  render(currentLocal);
  renderDashboard();
  if (currentRole === 'local') loadLocalPermissions(originalLocal);
  activeLocal.textContent = localSelect.options[localSelect.selectedIndex].text;
});

const tablaDashboard = document.getElementById("tabla-dashboard");
function renderDashboard(){
  get(ref(db, "registros")).then(snapshot=>{
    const map = {};
    snapshot.forEach(c => {
      const d = c.val();
      if (!map[d.empleado]) map[d.empleado] = { total: 0, locales: new Set() };
      map[d.empleado].total += parseInt(d.segundos) || 0;
      map[d.empleado].locales.add(d.local);
    });
    tablaDashboard.innerHTML = "";
    const entries = Object.entries(map).sort((a,b) => b[1].total - a[1].total);
    const localNames = { pocitos: "Pocitos", carrasco: "Carrasco", lagomar: "Lagomar" };

    entries.forEach(([emp, data], idx) => {
      const localesArray = Array.from(data.locales);
      const localText = localesArray.length === 1
        ? localNames[localesArray[0]]
        : localesArray.map(l => localNames[l]).join(", ");

      if (idx === 0) {
        tablaDashboard.innerHTML += `
        <tr class="champion-employee">
          <td>
            <span class="champion-name">
              <i class="fa-solid fa-crown champion-crown"></i>
              ${emp}
              <i class="fa-solid fa-crown champion-crown"></i>
            </span>
            <div class="champion-sparkles">
              <span></span><span></span><span></span><span></span><span></span>
            </div>
          </td>
          <td>${localText}</td>
          <td><strong>${formatHMS(data.total)}</strong></td>
        </tr>`;
      }
      else if (idx === 1) {
        tablaDashboard.innerHTML += `<tr class="second-employee">
          <td><i class="fa-solid fa-medal" style="color:#94a3b8;"></i> ${emp}</td>
          <td>${localText}</td>
          <td>${formatHMS(data.total)}</td>
        </tr>`;
      }
      else {
        tablaDashboard.innerHTML += `<tr>
          <td>${emp}</td>
          <td>${localText}</td>
          <td>${formatHMS(data.total)}</td>
        </tr>`;
      }
    });
  });
}

onValue(ref(db, "registros"), (snapshot) => {
  if (isLoggedIn) { render(localSelect.value); renderDashboard(); }
});

// === EDICIÓN ===
function openEditModal(id) {
  editingId = id;
  get(ref(db, "registros/" + id)).then(snap => {
    const d = snap.val();
    if (!d) return;
    editEmpleado.value = d.empleado;
    editDia.value = d.dia;
    editEntrada.value = d.entrada;
    editSalida.value = d.salida;
    editModal.classList.add('show');
    editEmpleado.focus();
  });
}

editModal.addEventListener('click', (e) => {
  if (e.target === editModal) {
    editModal.classList.remove('show');
    editingId = null;
  }
});

btnEditCancel.addEventListener('click', () => {
  editModal.classList.remove('show');
  editingId = null;
});

btnEditSave.addEventListener('click', () => {
  if (!editingId) return;
  if (!currentPermissions.canEdit) return alert("No tienes permiso para editar.");

  const nuevoEmpleado = editEmpleado.value.trim();
  const nuevoDia = editDia.value;
  const nuevaEntrada = editEntrada.value;
  const nuevaSalida = editSalida.value;

  if (!nuevoEmpleado) return alert("El nombre del empleado es obligatorio");
  if (!nuevaEntrada || !nuevaSalida) return alert("Debes completar entrada y salida");

  const nuevosSegundos = calcularSegundos(nuevaEntrada, nuevaSalida);

  get(ref(db, "registros/" + editingId)).then(snap => {
    const original = snap.val();
    set(ref(db, "registros/" + editingId), {
      ...original,
      empleado: nuevoEmpleado,
      dia: nuevoDia,
      entrada: nuevaEntrada,
      salida: nuevaSalida,
      segundos: nuevosSegundos
    }).then(() => {
      alert("Registro actualizado correctamente");
      editModal.classList.remove('show');
      editingId = null;
    }).catch(err => {
      alert("Error al guardar: " + err.message);
      console.error(err);
    });
  });
});

tabla.addEventListener("click", (e) => {
  const el = e.target.closest('button');
  if (!el) return;
  const id = el.dataset?.id;
  if (!id) return;

  get(ref(db, "registros/" + id)).then(snap => {
    const d = snap.val();
    if (!d) return;
    const canEditThis = (currentRole === 'master') ||
                       (currentRole === 'local' && (d.local === originalLocal || currentPermissions.canEditOtherLocations));
    if (!canEditThis) return alert("No tienes permiso para modificar este registro.");

    if (el.classList.contains("del-btn") && currentPermissions.canDelete) {
      if (confirm("¿Eliminar este registro?")) remove(ref(db, "registros/" + id));
    } else if (el.classList.contains("edit-btn") && currentPermissions.canEdit) {
      openEditModal(id);
    }
  });
});

/* Loader 5s */
let lp = document.getElementById('loaderProgress'); let p = 0;
const loadInt = setInterval(()=>{ p += 2; if(lp) lp.style.width = p + '%'; if(p >= 100) clearInterval(loadInt); },100);
setTimeout(()=>{ const scr = document.getElementById('loaderPage'); if(scr){scr.style.opacity='0';setTimeout(()=>scr.remove(),600);} },5000);

/* Tema oscuro */
const darkModeBtn = document.getElementById('darkModeBtn');
function applyTheme(saved){
  if(saved === 'dark'){ document.body.classList.add('dark'); darkModeBtn.innerHTML = '<i class="fa-solid fa-sun"></i>'; }
  else { document.body.classList.remove('dark'); darkModeBtn.innerHTML = '<i class="fa-solid fa-moon"></i>'; }
}
applyTheme(localStorage.getItem('theme') || 'dark');
darkModeBtn.addEventListener('click', () => {
  const isDark = document.body.classList.toggle('dark');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  applyTheme(isDark ? 'dark' : 'light');
});

// === PERMISOS ===
const DEFAULT_PERMISSIONS = { canAdd: true, canEdit: true, canDelete: true, canClear: true, canExportImport: true, canEditOtherLocations: false };
let permissionsCache = {};

btnOpenPermissions.addEventListener('click', async () => { permissionsModal.classList.add('show'); await loadAllPermissions(); });
btnClosePermissions.addEventListener('click', () => { permissionsModal.classList.remove('show'); });
permissionsModal.addEventListener('click', (e) => { if (e.target === permissionsModal) permissionsModal.classList.remove('show'); });

async function loadAllPermissions() {
  permissionsContent.innerHTML = '<p style="text-align:center;color:var(--muted);">Cargando...</p>';
  const users = ['pocitos', 'carrasco', 'lagomar'];
  permissionsCache = {};
  for (const user of users) {
    const snap = await get(ref(db, `userPermissions/${user}`));
    permissionsCache[user] = snap.val() || { ...DEFAULT_PERMISSIONS };
  }
  renderPermissionsUI();
}

function renderPermissionsUI() {
  const userLabels = { pocitos: 'Pocitos', carrasco: 'Carrasco', lagomar: 'Lagomar' };
  const items = [
    { key: 'canAdd', label: 'Agregar registro' },
    { key: 'canEdit', label: 'Editar registro' },
    { key: 'canDelete', label: 'Eliminar registro' },
    { key: 'canClear', label: 'Limpiar local' },
    { key: 'canExportImport', label: 'Exportar / Importar' },
    { key: 'canEditOtherLocations', label: 'Editar otros locales' }
  ];
  permissionsContent.innerHTML = Object.keys(permissionsCache).map(user => `
    <div class="user-perm-header"><i class="fa-solid fa-user-shield"></i> ${user}123 → ${userLabels[user]}</div>
    ${items.map(item => `
      <div class="perm-item">
        <span class="perm-label">${item.label}</span>
        <label class="switch">
          <input type="checkbox" data-user="${user}" data-key="${item.key}" ${permissionsCache[user][item.key] ? 'checked' : ''}>
          <span class="slider"></span>
        </label>
      </div>
    `).join('')}
  `).join('');
  permissionsContent.querySelectorAll('input').forEach(input => {
    input.addEventListener('change', (e) => {
      const user = e.target.dataset.user;
      const key = e.target.dataset.key;
      permissionsCache[user][key] = e.target.checked;
    });
  });
}

btnSavePermissions.addEventListener('click', async () => {
  btnSavePermissions.disabled = true; btnSavePermissions.textContent = 'Guardando...';
  try {
    for (const [user, perms] of Object.entries(permissionsCache)) {
      await set(ref(db, `userPermissions/${user}`), perms);
    }
    alert('Permisos guardados correctamente');
    permissionsModal.classList.remove('show');
  } catch (err) { alert('Error al guardar permisos'); console.error(err); }
  finally { btnSavePermissions.disabled = false; btnSavePermissions.textContent = 'Guardar Cambios'; }
});

function updateLocalSelect() {
  if (currentRole === 'local' && !currentPermissions.canEditOtherLocations) {
    localSelect.value = originalLocal;
    localSelect.querySelectorAll('option').forEach(opt => { opt.disabled = (opt.value !== originalLocal); });
  } else {
    localSelect.querySelectorAll('option').forEach(opt => { opt.disabled = false; });
  }
}

async function loadLocalPermissions(local) {
  const snap = await get(ref(db, `userPermissions/${local}`));
  currentPermissions = snap.val() || { ...DEFAULT_PERMISSIONS };
  applyPermissions();
}
</script>
</body>
</html>
